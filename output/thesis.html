<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="Content-Style-Type" content="text/css" />
        <meta name="generator" content="pandoc" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
                        <title></title>
        <style type="text/css">code{white-space: pre;}</style>
                                                    <style>
            body {
                font-family: Georgia;
                max-width: 800px;
                margin: 0 auto;
                line-height: 30px;
                font-size: 18px;
                padding-left: 350px;
                padding-right: 50px;
                color: #111;
            }
            
            h1, h2, h3, h4, h5, h6 {
                font-family: Arial;
            }
            
            h1 {
                padding-top: 200px;
                line-height: 50px;
            }
            h2 {
                padding-top: 30px;
            }
            h3 {
                padding-top: 20px;
            }
            h4 {
                padding-top: 10px;
            }
            p {
                text-align: justify;
            }
            p a {
                word-wrap: break-word;
                white-space: pre;
            }
            code {
                word-wrap: break-word;
            }
            blockquote {
                border-left: 3px solid #eee;
                margin-left: 20px;
                padding-left: 20px;
            }
            
            ::selection {
                background-color: #E4E4E4;
            }
            
            table {
                width: 100%;
            }
            table caption {
                font-weight: bold;
            }
            table tr {
                padding: 0;
                margin: 0;
                background-color: #f0f0f0;
            }
            table tr.even {
                background-color: #fafafa;
            }
            table td {
                margin: 0;
                padding: 3px 5px;
            }
            
            p span.added {
                color: green;
                background-color: #FFF3C5;
            }
            p span.removed {
                color: red;
                background-color: #FFF3C5;
            }
            
            #title-page {
                padding: 80px 0;
            }
            
            #TOC {
                position: fixed;
                left: 0;
                top: 0;
                overflow-y: scroll;
                height: 100%;
                background: #fafafa;
                max-width: 300px;
                font-family: Arial;
                font-size: 15px;
                line-height: 30px;
            }
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background-color: #ECECEC;
            }
            ::-webkit-scrollbar-thumb {
                background-color: #B0B0B0;
                border-radius: 8px;
            }
            #TOC > ul {
                padding-right: 10px;
            }
            #TOC ul {
                list-style: none;
                padding-left: 20px;
            }
            #TOC ul li a {
                text-decoration: none;
                color: #364149;
                text-overflow: ellipsis;
                display: block;
                white-space: nowrap;
                overflow: hidden;
            }
            #TOC ul li a:hover {
                color: #008cff;
            }
            
            .figure {
                text-align: center;
            }
            .figure p {
                text-align: center;
                font-style: italic;
            }
            .figure img {
                  width: 100%;
            }
            </style>
                <script src="js/jquery.js"></script>
        <script src="js/diff.js"></script>
        <script src="js/main.js"></script>
    </head>
    <body>
                <!--
                -->
        <div id="title-page">
            <h1>A User Study on Data-Driven Dosage of Heparin</h1>
            <h2>Joe Rowley</h2>
        </div>
                    <div id="TOC">
                <ul>
                <li><a href="#abstract">Abstract</a></li>
                <li><a href="#acknowledgements">Acknowledgements</a></li>
                <li><a href="#introduction"><span class="toc-section-number">1</span> Introduction</a></li>
                <li><a href="#background"><span class="toc-section-number">2</span> Background</a><ul>
                <li><a href="#traditional-dosing-of-heparin"><span class="toc-section-number">2.1</span> Traditional Dosing of Heparin</a></li>
                <li><a href="#predicting-therapeutic-outcome"><span class="toc-section-number">2.2</span> Predicting Therapeutic Outcome</a><ul>
                <li><a href="#logistic-regression-approach"><span class="toc-section-number">2.2.1</span> Logistic Regression Approach</a></li>
                <li><a href="#feature-selection"><span class="toc-section-number">2.2.2</span> Feature Selection</a></li>
                </ul></li>
                <li><a href="#summary-of-prior-work"><span class="toc-section-number">2.3</span> Summary of Prior Work</a></li>
                </ul></li>
                <li><a href="#heparin-dosage-calculator"><span class="toc-section-number">3</span> Heparin Dosage Calculator</a><ul>
                <li><a href="#functional-requirements"><span class="toc-section-number">3.1</span> Functional Requirements</a><ul>
                <li><a href="#data-processing"><span class="toc-section-number">3.1.1</span> Data Processing</a></li>
                <li><a href="#model-generation"><span class="toc-section-number">3.1.2</span> Model Generation</a></li>
                <li><a href="#model-prediction"><span class="toc-section-number">3.1.3</span> Model Prediction</a></li>
                </ul></li>
                <li><a href="#architecture"><span class="toc-section-number">3.2</span> Architecture</a><ul>
                <li><a href="#frontend"><span class="toc-section-number">3.2.1</span> Frontend</a></li>
                <li><a href="#backend"><span class="toc-section-number">3.2.2</span> Backend</a></li>
                </ul></li>
                </ul></li>
                <li><a href="#heparin-survey"><span class="toc-section-number">4</span> Heparin Survey</a><ul>
                <li><a href="#survey-design"><span class="toc-section-number">4.1</span> Survey Design</a></li>
                <li><a href="#architecture-and-implementation"><span class="toc-section-number">4.2</span> Architecture and Implementation</a></li>
                </ul></li>
                <li><a href="#survey-results"><span class="toc-section-number">5</span> Survey Results</a><ul>
                <li><a href="#primary-findings"><span class="toc-section-number">5.1</span> Primary Findings</a></li>
                <li><a href="#participant-profiles"><span class="toc-section-number">5.2</span> Participant Profiles</a></li>
                <li><a href="#dose-differences"><span class="toc-section-number">5.3</span> Dose Differences</a></li>
                <li><a href="#user-feedback"><span class="toc-section-number">5.4</span> User Feedback</a></li>
                </ul></li>
                <li><a href="#retrospective-and-next-steps"><span class="toc-section-number">6</span> Retrospective and Next Steps</a><ul>
                <li><a href="#challenges"><span class="toc-section-number">6.1</span> Challenges</a></li>
                <li><a href="#shortcomings-in-the-survey"><span class="toc-section-number">6.2</span> Shortcomings in the Survey</a></li>
                <li><a href="#implementation-differences-in-future-versions"><span class="toc-section-number">6.3</span> Implementation Differences in Future Versions</a></li>
                </ul></li>
                <li><a href="#conclusion"><span class="toc-section-number">7</span> Conclusion</a></li>
                <li><a href="#appendix-1-full-survey-results">Appendix 1: Full Survey Results</a><ul>
                <li><a href="#presurvey-questionnaire"><span class="toc-section-number">7.1</span> Presurvey Questionnaire:</a></li>
                <li><a href="#follow-up-survey"><span class="toc-section-number">7.2</span> Follow Up Survey</a></li>
                </ul></li>
                <li><a href="#appendix-3-research-resources">Appendix 3: Research Resources</a></li>
                <li><a href="#references">References</a></li>
                </ul>
            </div>
                                <!-- 
This is the Latex-heavy title page. 
People outside UCL may want to remove the header logo 
and add the centred logo
-->

<!-- This page is for an official declaration. -->
<!-- \vspace*{\fill} -->
<!-- \noindent  -->
<!-- \textit{ -->
<!-- I, Joseph Rowley confirm that the work presented in this thesis is my own. Where information has been derived from other sources, I confirm that this has been indicated in the thesis.
} -->
<!-- \vspace*{\fill} -->
<h1 id="abstract" class="unnumbered">Abstract</h1>
<!-- This is the abstract -->
<p>The intention of this study was to determine the feasibility of using statistical drug dosing tools in a mock clinical setting. We wanted to learn about both the technical implementation and user experience challenges involved with creating and using computer aided dosing tools. First a web application was developed using existing models for dosing heparin in ICU patients. This application was next developed into an interactive user survey. We found that doctors were generally more confidant and faster when dosing using the tools. [[add other results here too. It's good to avoid numbers in abstracts from what I recall]] In closing we recommend some best practices for future development of statistical drug dosing tools.</p>

<h1 id="acknowledgements" class="unnumbered">Acknowledgements</h1>
<!-- This is for acknowledging all of the people who helped out -->
<!-- add something about thanking the people taking the study  -->
<p>The models used in this tool were introduced Mohammad M. Ghassemi, Stefan E. Richter, Ifeoma M. Eche, Tszyi W. Chen, John Danziger, and Leo A. Celi in their paper <em>A data-driven approach to optimized medication dosing: a focus on heparin</em>. This project would not have been possible without Mohammad’s support.</p>
<p>Additionally, data used in these models was sourced from the MIMIC-II and MIMIC-III (<span class="citation">Saeed et al. (2011)</span>) medical databases, a project supported by the MIT Lab for Computational Physiology.</p>
<p>I also have many advisors who helped me with this project:</p>
<ul>
<li>Mohammad M. Ghassemi</li>
<li><a href="https://users.soe.ucsc.edu/~srikur/">Sri Kurniawan</a></li>
<li><a href="https://users.soe.ucsc.edu/~mrg/">Matthew Guthaus</a></li>
</ul>
<p>Additionally the following people were very influential in preparing me for this project:</p>
<ul>
<li><a href="https://users.soe.ucsc.edu/~davis/">James Davis</a></li>
<li><a href="https://users.soe.ucsc.edu/~kolaitis/">Phokion Kolaitis</a></li>
<li><a href="http://www.pamf.org/dr-philip-strong.html">Philip Strong</a> <!-- - [Leo Celi](https://connects.catalyst.harvard.edu/profiles/display/person/58103)  --> <!-- maybe add Kenneth Paik / Sana --></li>
</ul>
<p>Finally, this project would not have been possible without the unwavering moral and technical support of my parents <a href="http://www.uwhealth.org/findadoctor/profile/howard-a-rowley-md/7329">Howard Rowley</a> and <a href="http://www.uwhealth.org/findadoctor/profile/carol-a-diamond-md/5867">Carol Diamond</a>.</p>
<!-- Use the \newpage command to force a new page -->

<p></p>

<h1 id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<!-- potential titles:

    Statistical Drug Dosing: A User Study on Heparin Dosing
    A User Study on Data-Driven Dosage of Heparin 
        

 -->
<!-- ## Background -->
<!-- 
Explain how I reimplemented a research paper into a real world web application and then tested it. 

- keep it relatively high level  
- current dosing practices 
- how retrospective data comes into play, potential improvements it offers. Increasing patient care outcomes. Cost/length of stay outcomes. Could revolutionize the ways in which drug trails occur. Drug trails traditionally use a rather homogeneous group of people, and test them to with doses to see if there are any adverse effects. After we test with the homogeneous group, the guidelines developed are used for patients that do not fit in with the testing cohort, so no guidelines for proper dosing exist for these patients. 
- purpose of thesis, demonstrate a potential interface for an actual model that has been peered reviewed gather insights on potential issues with dosing. Also create a sample web application that works for this use case, so that the technique can be more easily generalized to other drugs such as ....???? 
- 
The intention of this study was to determine the feasibility of using statistical drug dosing tools in a mock clinical setting. We wanted to learn about both the technical implementation and user experience challenges involved with creating and using computer aided dosing tools. First a web application was developed using existing models for dosing heparin in ICU patients. This application was next developed into an interactive user survey. We found that Doctors were generally more confidant and faster when dosing using the tools. [[add other results here too. It's good to avoid numbers in abstracts from what I recall]] In closing we recommend some best practices for future development of statistical drug dosing tools.

 -->
<!-- 

intro
talk about what I did
-- implemented exisiting tool
-- implemented a survey
-- collected responses




 -->
<p>The primary goal of this study was to determine the technical implementation challenges and user experience challenges involved with a statistical dosing tool. Specifically, we implemented a heparin dosing tool that was first introduced in the paper <em>A data-driven approach to optimized medication dosing: a focus on heparin</em> <span class="citation">(Ghassemi et al. 2014)</span>. In the paper a statistical model is generated for predicting an optimal infusion rate for heparin for patients in intensive care units (ICUs). In this study, we reimplemented their existing models into an interactive web application, which allows the user to generate dosage guidelines based on a patient's features. Next a user study application was created, which presents the doctors with a patient case. The doctor initially provides their own suggestion for the infusion rate and is then presented with the model's prediction for an optimal infusion rate. After the doctor views the model, they have the opportunity to adjust their initial dose and provide a reasoning for their dose adjustments. Their interaction with the tool yields many metrics, including number of dose adjustments, speed of dosing, number of times guidelines were viewed.</p>
<!-- One serious disadvantage of heparin risk factor analyses based on clinical trials alone is that they exclude patients who exhibit a high propensity for bleeding or severe complications caused by bleeding [2]. Retrospec- tive analyses like ours are able to overcome this issue by utilizing clinical data that is reflective of the entire pop- ulation actually receiving treatment.  -->
<!-- Their final multiple feature model improved outcome classification over a weight-only with a volume under the surface (VUS) of 0.48 vs. 0.42. -->
<!-- Statistical dosing tools offer an alternative to traditional dosing methodologies, which by nature cannot be tuned to a specific patient's every condition every time. Additionally, traditional dosing often is backed by heuristics, knowledge accumulated overtime by more experienced doctors. This knowledge is not peer reviewed and cannot be easily transfered to other new doctors. The promise of statistical dosing is that it   -->
<!-- 
To include a reference, add the citation key shown in the references.bib file. 
[@Cousteau1963].
-->
<!-- 
This is a brief outline of what went into each chapter. **Chapter 1** gives a background on duis tempus justo quis arcu consectetur sollicitudin.  **Chapter 2** discusses morbi sollicitudin gravida tellus in maximus.  **Chapter 3** discusses vestibulum eleifend turpis id turpis sollicitudin aliquet.  **Chapter 4** shows how phasellus gravida non ex id aliquet. Proin faucibus nibh sit amet augue blandit varius. -->
<h1 id="background"><span class="header-section-number">2</span> Background</h1>
<h2 id="traditional-dosing-of-heparin"><span class="header-section-number">2.1</span> Traditional Dosing of Heparin</h2>
<p>Heparin is an anticoagulant medication administered intravenously to patients with blood clots. Specifically it is often used for strokes, pulmonary embolism (blockage in an artery in the lung), acute coronary syndrome (e.g. heart attack), and many other conditions. The general protocol for dosing heparin is to initially order baseline lab results for the patient. These values combined with context of the patients condition allow a doctor to determine the infusion rate and if a bolus (a single large initial dose) is required. The primary metric used for monitoring patient progress is activated partial thromboplastin time (APTT). After the infusion is started the patient is monitored and the dose is adjust periodically. Most often new labs are ordered every 6 hours <span class="citation">(Lisa Gryttenholm 2004)</span>, <span class="citation">(Washington Pharmacy Services 2014)</span>.</p>
<!--
After the introductory chapter, it seems fairly common to 
include a chapter that reviews the literature and 
introduces methodology used throughout the thesis.
-->
<!-- Explain what heparin is, how heparin is traditional prescribed.   -->
<!-- reference dosage guidelines which are in the appendix.  -->
<!-- ## High Level -->
<!-- At a high level explain what we want to do - remove doctors manual process/guessing heuristics.   -->
<!-- we want to predict the amount of heparin needed to get a therapeutic aptt. explain aptt is our marker for success. explain that there is a lot of data that can be used for predictions - explain how they selected their features.   -->
<h2 id="predicting-therapeutic-outcome"><span class="header-section-number">2.2</span> Predicting Therapeutic Outcome</h2>
<p>The objective of the dosing tool is determine an ideal initial infusion rate, such that patient has the highest probability of reaching a therapeutic state in 6 hours time. A therapeutic state is defined as an APTT value of between 60 seconds and 100 second. To predict an optimal dose Ghassemi et al. employed the use of multi-variant logistic regression.</p>
<h3 id="logistic-regression-approach"><span class="header-section-number">2.2.1</span> Logistic Regression Approach</h3>
<!-- Logistic regression  -->
<p>The objective of the model was to determine the probability that patient would end in one of three categories: sub-therapeutic, therapeutic, or supra-therapeutic. A patient can by definition only be in one category at a time. This lead Ghassemi et al. to the following equation:<br />
(1) <span class="math inline">1 = <em>P</em>(<em>s</em><em>u</em><em>b</em> − <em>t</em><em>h</em><em>e</em><em>r</em><em>a</em><em>p</em><em>e</em><em>u</em><em>t</em><em>i</em><em>c</em>)+<em>P</em>(<em>t</em><em>h</em><em>e</em><em>r</em><em>a</em><em>p</em><em>e</em><em>u</em><em>t</em><em>i</em><em>c</em>)+<em>P</em>(<em>s</em><em>u</em><em>p</em><em>r</em><em>a</em> − <em>t</em><em>h</em><em>e</em><em>r</em><em>a</em><em>p</em><em>e</em><em>u</em><em>t</em><em>i</em><em>c</em>)</span></p>
<p>The challenge of using logistic regression to predict therapeutic outcomes is that the probability of a therapeutic outcome is not a strictly monotonic function. So using logistic regression directly to predict P(therapeutic) will not work. That being said, the probability of sub-therapeutic and supra-therapeutic outcomes are monotonically decreasing and increasing functions respectively. Given these properties, we can use multinomial logistic regression to determine functions for sub-therapeutic and supra-therapeutic aPTT. Using equation 1 we can then determine the probability of a therapeutic outcome.<br />
At this point a case been has made that multinomial logistic regression may be an appropriate tool, but there are a few considerations that Ghassemi et al. took with regards to choosing the form of regression. There are many forms of multinomial logistic regression with subtle but important differences. There is a natural order to the classifications (sub-therapeutic, therapeutic, supra-therapeutic), so ordinal logistic regression could be considered. The challenge with ordinal logistic regression, however, is that it makes the assumption of proportional odds, so regression intercept terms vary across classes while regression coefficients are shared across classes. In the words of the original authors <em>&quot;it assumes that explanatory features maintain identical effects across varying ranges of the outcome&quot;</em>[citation appendix]. Instead the ordinal regression they instead used a modified version of standard multinomial logistic regression, which utilized a flexible reference category. That is instead of using a single class to predict the outcome that is not being modeled, they used all classes. So when modeling supra-therapeutic aPTT, standard multinomial logistic regression would reference either therapeutic or sub-therapeutic aPTT classes, while their approach referenced both classes. This choice was demonstrated to have significant effects on the validity of their models [citation to appendix, section 2].</p>
<!-- To predict the probability of a therapeutic outcome  -->
<!-- explain different techniques that could be used (svm, logistic regression, others listed in their paper)   -->
<!-- then explain that mohammad et al chose to use logistic regression because it had a natural relationship with this...   -->
<!-- explain what logistic regression is and how they used the multiparameter model.   -->
<!-- explain how they choose features for the model.   -->
<!-- explain assumption of proportional odds-   -->
<h3 id="feature-selection"><span class="header-section-number">2.2.2</span> Feature Selection</h3>
<p>There are innumerable potential features one could consider as predictors of patient outcome. In their paper, Ghassemi et al. determined the salient features as follows: age, SOFA score, Elixhauser, Heparin dose, APTT Measurement time, Creatinine, Ethnicity, Gender, ICU type, presence of pulmonary embolism, obesity, presence of end stage renal failure.</p>
<h2 id="summary-of-prior-work"><span class="header-section-number">2.3</span> Summary of Prior Work</h2>
<p>The original paper and associated appendix document the efforts taken to validate the models. To summarize, they partitioned their dataset, dedicating 70% to training and 30% for validation. They then compared the calculated the predicted classification for each patient using both a full featured model and a weight-only model. The full featured model was more accurate than the weight-only approach as measured by Volume Under the Receiver Operating Characteristic Surface (the multiple class version of Area Under Receiver Operating Characteristic Curve), with values of 0.48 vs 0.42 <span class="citation">(Ferri et al. 2003)</span>.<br />
In closing, they noted that a randomized controlled trial would be necessary to determine if this mechanism is more effective for dosing. This thesis project represents the initial steps towards this trial.</p>
<!-- Summary of the results from their paper.  It is better than weight based system alone.   -->
<!-- They weren't able to test if it was better than an actual doctor because you'd need to have the system in place to do that. That is where this system/survey comes into play.   -->
<!-- Insert an unordered list -->
<!-- - first item in the list
- second item in the list
- third item in the list

 -->
<h1 id="heparin-dosage-calculator"><span class="header-section-number">3</span> Heparin Dosage Calculator</h1>
<!-- ## Introduction -->
<p>This project is composed of two key components. The first is a &quot;dose calculator&quot; which contains all the functionality required to determine the optimal dose for a given patient. The second component is a survey that incorporates the calculator and is used to study how doctors interact with the dosing tool. We now describe the calculator.</p>
<!-- explain what it is - a standalone calculator, to familiar doctors with the technique.  -->
<!-- Goals of System   -->
<!-- - mobile ready...  -->
<!-- talk about user experience/ui design. -->
<h2 id="functional-requirements"><span class="header-section-number">3.1</span> Functional Requirements</h2>
<p>The purpose of the calculator is to determine the probability functions for sub-therapeutic, therapeutic, supra-therapeutic aPTT for a range of infusion amounts for a given patient. The calculator can be broken into three steps:<br />
1. Access and refine Dataset<br />
2. Calculate static models<br />
3. Make a prediction based on a given patient's features.</p>
<h3 id="data-processing"><span class="header-section-number">3.1.1</span> Data Processing</h3>
<p>The data source for the original study was the MIMIC II database [citation]. MIMIC is an open access database consisting of over 40,000 deidentified patient encounters from Beth Israel Deaconess Hospital's ICUs. It is hosted at MIT's Lab for Computational Physiology. The majority of patients in an ICU do not receive heparin, so filtering by medication was needed. This was accomplished by a series of SQL queries on a local machine. Furthermore, we worked to maintain an identical dataset as was used in the original dataset. This required filtering out all transfer patients and all patients missing required features. Additionally some features viz. Elixhauser comorbidity index, mean Sequential Organ Failure Assessment (SOFA), required manual calculation on a per patient basis, as they were not available directly from MIMIC. This yielded a dataset of approximately 1,600 patients. This number varies depending on the features supplied for a given prediction.</p>
<p>This data munging was primarily done in Python using the Pandas library, but also required PostgreSQL for hosting the database. SQL queries were composed by hand. To prepare the data for model generation we needed to code several variables. Specifically, we needed to add binary classifiers for sub-therapeutic and supra-therapeutic to each patients dataset. Additionally a binary classifier was needed for ethnicity, and we followed the original coding used in the paper (white and non-white).</p>
<!-- 
talk about mimic ii / iii - was it, wheres it from etc. 
what is needed to get a cohort
what else you need to look up to get a full dataset
that i ended up getting dataset from Mohammad
that i needed to filter... started with 4,000, got down to x patients by filtering 
out transfers etc. 

then talk about tech I used to do this
- python, numphy, sql, etc... 
  -->
<h3 id="model-generation"><span class="header-section-number">3.1.2</span> Model Generation</h3>
<p>Once the dataset was prepared, generating the models was fairly simple. We used the Python library Scikit-learn's implementation of multinomial Logistic Regression to compute the two logistic regressions. Once the two logistic regressions for sub-therapeutic and supra-therapeutic aPTT are generated they can be stored for later use as long as the dataset is static. We avoided doing this to simulate a real world scenario where data is constantly being added overtime. <!-- 
need to generate the 2 models using the features in python and x function calls.

 --></p>
<h3 id="model-prediction"><span class="header-section-number">3.1.3</span> Model Prediction</h3>
<p>To generate the final dose curves for a specific patient we use scikit-learn's logistic regression predict_proba function. A function was created to output the probability of sub-therapeutic, sup-therapeutic aPTT given a patients features and a dose. For graphical purposes we call this function repeatedly for varying infusion rates in the range of 0 to 34 units/Kg/HR in steps of 0.5 units/Kg/HR. Predicting the specific infusion rate which maximizes the probability of a therapeutic outcome can also be thought of as finding the point which minimizes the sum of the probabilities of sub-therapeutic and supra-therapeutic (see equation 1). Using this fact we used the python library scipy's minimize_scalar function which implements Brent's Method and let it solve for the highest probability with a tolerance of .01%. The infusion rate curves and the optimal dose are then cached in Postgres for future queries that match the same patient features, given that the initial dataset has not changed.</p>
<!-- from scipy.optimize import minimize_scalar -->
<!-- from sklearn.linear_model import LogisticRegression -->
<!-- 
talk about how I used a loop to create the dose curve
talk about how I used the maximization function to maximize the probability of therapeutic 
 -->
<h2 id="architecture"><span class="header-section-number">3.2</span> Architecture</h2>
<!-- maybe include a diagram -->
<!-- Figure \ref{ref_a_figure} shows how to add a figure. Donec ut lacinia nibh. Nam tincidunt augue et tristique cursus. Vestibulum sagittis odio nisl, a malesuada turpis blandit quis. Cras ultrices metus tempor laoreet sodales. Nam molestie ipsum ac imperdiet laoreet. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. -->
<h3 id="frontend"><span class="header-section-number">3.2.1</span> Frontend</h3>

<p>The frontend for the application was built in Angular.js. Angular.js is client-side MVC (Model View Controller) framework that was chosen for it's strengths in quick prototyping. The user interface was built on Twitter Bootstrap, as it was familiar to the authors, is relatively easy to use and offers built in responsive design. Additionally, it has many CSS components such as nice forms and progress bars that are useful for the design.<br />
For graphing the D3.js, NV-D3 and Angular-nvd3 libraries were used which enables inserting graphs using simple directives. Figure  shows an example output of the standalone calculator as seen in <a href="#appendix-2-application-user-interface">Appendix 2</a> or <a href="https://hepstack-stage.herokuapp.com/#/calc">online</a>. The two prominent dots represent the optimal doses for each model. Note that in this example, the weight-only model predicts that the probability that the patient will reach therapeutic state is higher than the all features model.</p>
<!-- explain this is a standalone version
include screen shot maybe? 
explain how user interacts with this on the frontend 
explain how frontend was built 
    angular, bootstrap, nvd3, etc...
 -->
<h3 id="backend"><span class="header-section-number">3.2.2</span> Backend</h3>

<p>The backend for the application utilizes Python's Flask webframe work. Data is stored in postgreSQL and accessed through the sqlalchemy object relational mapping library. The frontend interfaces with the server via a stateless RESTful API which enables the exchange of json data. Figure  shows an example of how a client interacts with the backend server currently.</p>
<!-- 

explain how frontend and backend connect
what calls are made, idk. 

 -->
<!-- architecture here... include a figure.F igure \ref{ref_a_figure} shows how to add a figure. Donec ut lacinia nibh. Nam tincidunt augue et tristique cursus. Vestibulum sagittis odio nisl, a malesuada turpis blandit quis. Cras ultrices metus tempor laoreet sodales. Nam molestie ipsum ac imperdiet laoreet. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. -->
<!-- ![RV Calypso is a former British Royal Navy minesweeper converted into a research vessel for the oceanographic researcher Jacques-Yves Cousteau. It was equipped with a mobile laboratory for underwater field research. \label{ref_a_figure}](source/figures/example_figure.pdf) -->
<!-- ## Implementation  -->
<!-- talk about the stack, tools used etc.  -->
<!-- talk about how the tools used helped ensure rapid prototyping and good ui.  -->
<!-- blank lines at end -necessary for template -->
<h1 id="heparin-survey"><span class="header-section-number">4</span> Heparin Survey</h1>
<!--
After the introductory chapter, it seems fairly common to 
include a chapter that reviews the literature and 
introduces methodology used throughout the thesis.
-->
<h2 id="survey-design"><span class="header-section-number">4.1</span> Survey Design</h2>

<p>The primary objective of the survey was to learn about the user experience challenges involved with data-driven dosage techniques. To do this a test interface was developed and several medical doctors of varying disciplines attempted to use it. You can view the interface <a href="https://hepstack-stage.herokuapp.com/">online</a> or in <a href="#appendix-2-application-user-interface">Appendix 2</a>. The survey consisted of five patient cases developed by domain experts to cover multiple different use cases for heparin. A doctor would first agree to a research disclosure, then fill out a short questionnaire about their background and relevant experience (figure ). Next an instruction page was displayed explaining the survey (figure , ). Once the doctor read over the instructions and guidelines, they were presented with their first case which consists of some lab results and a short admission note (figure ). It was their task to determine a potential infusion rate based on traditional heparin dosing guidelines that were available to them. After choosing an infusion rate, the optimal dose model was displayed (figure ). Unlike the standalone calculator, with the survey version of the graph does not present the weight-only model. It does however plot the user's initial infusion rate on the estimated therapeutic curve in black, so they can visualize the estimated dose versus their own dose (figure ). The doctor then had the option of either adjusting the dose or sticking with their initial dose. Whenever dosing the doctor was able to leave notes to explain their reasoning. This task then was repeated for the remaining four patients. After completing the test, there was a short follow-up questionnaire consisting of a few questions to gauge receptiveness to the tool and measure any change in confidence in the tool. Additionally, participants were asked for other places they thought the tool could be used(figure ). Due to financial and scope limitations, we could not compensate participants for their time taking the survey. As a result all volunteers were acquaintances or friend's of friends of the author.</p>
<!-- Additionally, we wanted to learn about any advantages and disadvantages the technique brings to doctors. To do thi -->
<!-- what the goals of the survey were. - what did we want to learn? hypothesis      -->
<!-- how the survey was conducted.  -->
<!-- how we decided what information to ask about.  -->
<!-- what information that was logged.   -->
<h2 id="architecture-and-implementation"><span class="header-section-number">4.2</span> Architecture and Implementation</h2>
<p>The survey was implemented using the same technological stack as the calculator (Angular.js and Bootstrap on the frontend, Python and Flask on the backend). By utilizing a SPA (single page application) methodology we were able to quickly iterate and make many revisions. There were several candidate versions of the survey developed and tested with domain experts for feedback. The final iteration allows for the most direct input of comments from doctors, instead of relying on proxy metrics such as time to complete cases that are similar too each other.</p>
<!-- talk about the stack, tools used etc. how it was implemented. user experience.   -->
<!-- blank lines at end -necessary for template -->
<h1 id="survey-results"><span class="header-section-number">5</span> Survey Results</h1>
<!--
After the introductory chapter, it seems fairly common to 
include a chapter that reviews the literature and 
introduces methodology used throughout the thesis.
-->
<!-- maybe add a little intro... short description of primary findings -->
<h2 id="primary-findings"><span class="header-section-number">5.1</span> Primary Findings</h2>
<p>Participants adjusted their doses 72% of time after reviewing the model, which resulted in a higher probability of therapeutic outcome in 82% of the adjustments. Additionally, participants reported greater confidence when using the tool but also expressed some hesitation with adopting the tool, often due to a lack of understanding of the underlying models. More information follows. Access to the extended survey results can be found in <a href="#appendix-1-full-survey-results">Appendix 1</a>.</p>
<h2 id="participant-profiles"><span class="header-section-number">5.2</span> Participant Profiles</h2>
<p>In total nine participants, all medical doctors completed the survey. They range in experience from 4 to 32 years practicing. Of the nine, one participant is a practicing physician in Ethiopia, and the rest practice in the United States. One participant completed the study from a mobile device and the others from a traditional laptop or desktop computer. Five of the nine reported that they frequently prescribe heparin (at least once a week) in their current position. One participant reported prescribing it infrequently (once a month), two reported prescribing it rarely and one reported prescribing never. All participants reported that in sometime in the past they prescribed it frequently. The participant medical specialties can be found in Table , but ranged from hematopathology to neuroendovascular surgery. Although nine participants took the survey, one participant's infusion rates were disqualified from the data analysis because they were 100 times greater than the mean. Their comments were still kept for additional analysis.</p>
<!-- ## Cumulative Results -->
<!-- how many difference people took survey, specialties, time since last dosed heparin.  -->

<h2 id="dose-differences"><span class="header-section-number">5.3</span> Dose Differences</h2>
<p>Each of the eight participants prescribed heparin twice to five different patients, yielding a total of 80 infusion rates. In Table , for each patient there is a suggested optimal infusion rate (IR) in the top header. This is the number that was displayed to the user after they entered their initial infusion rate <em>IR1</em>. <em>IR2</em> is the value they prescribed after viewing the optimal dosage curve and the suggested infusion rate.<br />
In the 40 trials, participants choose only 11 times to maintain their initial infusion rate. In other words, 72% of the time participants adjusted their dose after viewing the model's suggested dose. In five of the 29 times that a change was made, the change resulted in lower probability of a therapeutic outcome than the original dose. All five of these events occurred with participant number one, which may reflect the user struggling to understand how to use the tool.</p>
<p>As for the reasoning for adjusting doses, they vary greatly as can be seen in the appendix in Table . Those who choose to adjust towards the model values generally expressed trust in the model, while some users, in particularly those who currently prescribe heparin frequently where more wary of it. Some users explained they wanted to adjust the infusion rate based features that were considered in the model, or that they would want to adjust based on Anti-Xa Assay (an assay designed to monitor anticoagulant therapy <span class="citation">(Reka G Szigeti 2014)</span>.) Others expressed that their initial dose was close enough, and that they preferred round numbers, since dosing in non-integer units is not always possible.</p>
<h2 id="user-feedback"><span class="header-section-number">5.4</span> User Feedback</h2>
<p>Eight of the nine participants reported they felt more confident dosing with the tool than without. One participant said it did not affect their confidence. Although in general users reported greater confidence with the tool, the majority expressed concern with adopting it due to a lack of understanding of the models. As one participant noted the models are &quot;a bit of a 'black box'.&quot; Other users noted that they were concerned the tool was not adjusting for some specific complications. Another user noted they were concerned about adopting it given there has not been a validation trial for the technique. These concerns and others will be addressed in the following section.</p>
<!-- blank lines at end -necessary for template -->
<h1 id="retrospective-and-next-steps"><span class="header-section-number">6</span> Retrospective and Next Steps</h1>
<!--
After the introductory chapter, it seems fairly common to 
include a chapter that reviews the literature and 
introduces methodology used throughout the thesis.
-->
<h2 id="challenges"><span class="header-section-number">6.1</span> Challenges</h2>
<p>Although most participants expressed that the dosing tool gave them greater confidence, the majority also had reservations with adopting the tool in their practice. Their common concern involved their understanding of how the tool worked. This is concern appropriate, as it reflects a conservative approach to experimenting on best practices. One reason for their lack of understanding can be attributed to the nature of this study, in that participants completed the survey on their own time and were given no incentives for completing the survey. As such, many users may have read the system explanation quickly.<br />
Additionally, the technique used for dosing, although not terribly complex, is not trivial to understand. Physicians in general cannot be asked to learn how a logistic regression works or how these models are built. Simply speaking, their time is very valuable and limited. Thus, experimental techniques need to be validated in formal clinical setting with physicians who are invested in understanding and participating in a trial of the new tools. Another concern expressed was that the tool did not consider other potential features when dosing patients. Although these features can be added overtime, as the data becomes available and coded appropriately, this concern speaks to the greater issue of user interaction with the model. In its current state the standalone calculator allows physicians to view the weight-only model and the all features model. This gives them a better understanding of how these features change the therapeutic curve. Future versions of this tool should allow the user to enable and disable certain a given feature, so they can have a better understanding of the effects of the feature on the model outcome. This understanding could potentially come in the form of additional visualizations like the original graph or arguably better in the form of written descriptions, e.g. &quot;due to SOFA score causes a deviation of 3% from normal dosing.&quot; The initial version of this project included a crude nearest neighbor visualization, but that feature was not incorporated in the final version due to time limitations. Increasing user interaction with the tool will hopefully address some knowledge and trust issues with the current system.</p>
<h2 id="shortcomings-in-the-survey"><span class="header-section-number">6.2</span> Shortcomings in the Survey</h2>
<p>This study has no shortage of problems. The problems generally come from a lack of resources, in terms of time and money. A funded study would allow for a greater number of participants with specific domain expertise. Additionally the participant selection process would not be limited to friends of the researchers, which may have skewed the results. Funding would also allow for time for researchers to work with participants to better understand the model. Given the problems with the survey, and limited number of participants, the results are still very valuable as they clearly reveal areas for future improvement in the system.</p>
<!-- ## Places for Future Research -->
<!-- how did the doses differ in part 1 and part 2 of the survey.  -->
<h2 id="implementation-differences-in-future-versions"><span class="header-section-number">6.3</span> Implementation Differences in Future Versions</h2>
<p>The experimental nature of this project has lead to a software implementation that is limited in several ways. It served its primary purpose as a tool for a research study fairly well, but it is not &quot;real world&quot; ready in its current form. In future versions we'd like to see improved logging, system documentation, automated unit testing on builds, and better scaling performance (possibly utilizing redis). Additionally, the overall design should be more modular, such that it is easier to try out and compare different candidate models (e.g. Ensemble Learning, Neural Networks, SVMs, etc.) on different drugs. Automated testing could even run trial comparisons and compute statistics on models. From a data processing perspective, an entire subsystem should be designed and built for selecting data from the medical records database and translating it into a suitable form for models. There should also be tools for validating the cohort selection. This is not a trivial task when working with a specific medical record database, and becomes much more challenging when attempting to interface with other databases. Defining the generic interface used for selecting the cohort from the database will be challenging. Finally the data will also need to be validated and then translated (coded) to appropriate values for a given model.<br />
On the frontend, user analytics could be improved, as it would be ideal to know more about the user's device and how they interact on a per-click basis. One final improvement on the client would be modifying the data model, such that instead of requesting an estimate for a specific patient, it requests a static model that has been precomputed on the sever. Then the user can manually modify features and the estimated probability curves are computed client side. This should allow for a much more responsive experience for the user, providing them instantaneous feedback for each feature change made, instead requiring a request to the server for each change. The dosage curves could be computed in a separate thread using web workers. Additionally, by implementing the predictions client side, patient data does not need to be transfered to an external server (easing HIPAA compliance), and the client can be fully functional offline which is ideal for low resource environments such as developing countries.</p>
<!-- documented, tested, scalable, maintainable/easy to modify models, design well though out -->
<!-- better build system -->
<!-- better analytics/guidelines -->
<!-- - transfer model to device so it can do queries more quickly -->
<!-- - instead of static data source have real medical database -->
<!-- - easily interchangeable models -->
<!-- - better analytics  -->
<!-- blank lines at end -necessary for template -->
<h1 id="conclusion"><span class="header-section-number">7</span> Conclusion</h1>
<!--
After the introductory chapter, it seems fairly common to 
include a chapter that reviews the literature and 
introduces methodology used throughout the thesis.
-->
<!-- ##   -->
<!-- Summary of work that was done, then summary of results. Then summary of places for future work.  -->
<!-- Participants adjusted their doses 72% of time after reviewing the model, which resulted in a higher probability of therapeutic outcome in 82% of the adjustments. Additionally, participants reported greater confidence when using the tool but also expressed some hesitation with adopting the tool, often due to a lack of understanding of the underlying models. More information follows. Access to the extended survey results can be found in [Appendix 1](#appendix-1-full-survey-results). -->
<p>The central focus of this study was to implement an interactive data-driven dosage tool and test its usability with medical doctors. While doing this we learned about domain specific, technical, and usability challenges. The goal of our work was to provide sufficient information such that a new version could be built and tested in a formal clinical setting. While the majority of participants felt more confident prescribing heparin using the tool, they also overwhelming expressed a need for a greater understanding of the underlying models making the predictions. This speaks to a usability problem that will be addressed in future versions by creating a more interactive, learning based tool. The future architecture presented will also open the door to dosing other drugs and trying out other models beyond logistic regression. These techniques will provide personalized insight in complex cases involving multiple drug interactions in unique patient cohorts. Without question, computers will aid in dosing drugs in the future, and this will improve the quality of patient care, while decreasing hospital stay times and the cost of care.</p>
<!-- excited about building a system that that can apply this methdology to other drugs -->

<!-- blank lines at end -necessary for template -->
<h1 id="appendix-1-full-survey-results" class="unnumbered">Appendix 1: Full Survey Results</h1>
<!-- 
This could be a list of papers by the author for example 
-->
<ul>
<li>Project Resources
<ul>
<li><a href="https://github.com/joer14/ThesisPaper/blob/master/publicCodeEn.zip?raw=true">Link to Client Side and Server Side Code Archive (Password Protected)</a></li>
<li><a href="https://hepstack-stage.herokuapp.com/responses">Link to Raw Survey Results Data</a></li>
</ul></li>
</ul>
<h2 id="presurvey-questionnaire"><span class="header-section-number">7.1</span> Presurvey Questionnaire:</h2>
<ol style="list-style-type: decimal">
<li>What are your credentials? - MD - MD/PhD - NP - Other<br />
</li>
<li>What is primary medical specialty? - (e.g. Obstetrics)<br />
</li>
<li>How long have you been practicing in a clinical setting? - (e.g. 10 years)<br />
</li>
<li>In your current position how often do you prescribe heparin or other anticoagulants?
<ul>
<li>Frequently - (at least once a week)</li>
<li>Infrequently - (once a month)</li>
<li>Rarely - (once a year or so)</li>
<li>Never</li>
</ul></li>
<li>In the past did you ever prescribe heparin or other anticoagulants more frequently? If so, how often?
<ul>
<li>Frequently - (at least once a week)<br />
</li>
<li>Infrequently - (once a month)</li>
<li>Rarely - (once a year or so)</li>
<li>Never - I haven’t prescribed heparin or other anticoagulants</li>
</ul></li>
<li>Have you ever worked in an ICU? If so, to what extent?
<ul>
<li>(e.g During my residency I had 2 rotations lasting roughly 10 weeks each in different ICUs.)</li>
</ul></li>
</ol>


<h2 id="follow-up-survey"><span class="header-section-number">7.2</span> Follow Up Survey</h2>
<ol style="list-style-type: decimal">
<li>Did you feel more confident prescribing heparin when using the models?
<ul>
<li>I felt more confident using the models.<br />
</li>
<li>I felt less confident using the models.</li>
<li>The models did not affect my confidence.</li>
</ul></li>
<li>What hesitations do you have about adopting statistical dosing tools?<br />
</li>
<li>Are there any specific areas you’d like to see a tool like this being used?<br />
</li>
<li>If you have any further comments, questions, suggestions, ideas for improvement, etc please enter them below.</li>
</ol>






<!-- 
Table: Here's the caption. It, too, may span
multiple lines.

Here is a footnote reference,[^1] and another.[^longnote]

[^1]: Here is the footnote.

[^longnote]: Here's one with multiple blocks.

* fruits
    + apples
        - macintosh
        - red delicious
    + pears
    + peaches
* vegetables
    + broccoli
    + chard

    test  
    verabitum text  
    we will see if this works  
- api definition 
- link to test software
- link to source code git repos
- screenshots and links to alternative design for testing aPTT over time
- links to data sources/notebook of documentation
- extended results from survey.  
.. tables with stats like ave, std deviation etc for each patient 1-10
..- 
<!-- 
1. First ordered list item
2. Another item  
Unordered sub-list. 
1. Actual numbers don't matter, just that it's a number 
--1. Ordered sub-list  
--1. Ordered sub-list
--1. Ordered sub-list  
4. And another item.

1. first item in the list
1. second item in the list
 - subitem
  - subitem 
1. third item in the list

- an entry
- another entry  
 - some sub entry without leading bullet
- - some sub entry with leading bullet
 - another entry for another entry
 - - blablabla
 - - blublublu
 - - - dfdf
- - - - also some way  -->

<h1 id="appendix-3-research-resources" class="unnumbered">Appendix 3: Research Resources</h1>
<p>Below is a list of tools I used while creating the application:</p>
<ul>
<li>Web App Tools: Grunt, Bower, NPM</li>
<li>Typesetting: <a href="https://github.com/tompollard/phd_thesis_markdown">Tom Pollard's Markdown to Latex Scripts</a></li>
</ul>
<p>Below is a list of tutorials and resources I found helpful while creating the application:</p>
<ul>
<li>Sahil Diwan's <a href="http://blog.sahildiwan.com/posts/flask-and-postgresql-app-deployed-on-heroku/">Making a Flask app using a PostgreSQL database and deploying to Heroku</a></li>
<li>Yuval Adam's <a href="http://blog.y3xz.com/blog/2012/08/16/flask-and-postgresql-on-heroku">Flask and PostgreSQL on Heroku</a></li>
<li>Real Python's <a href="https://realpython.com/blog/python/flask-by-example-integrating-flask-and-angularjs/">Flask by Example - Integrating Flask and AngularJS</a></li>
<li><a href="https://mimic.physionet.org/about/mimic/">MIMIC-III Critical Care Database Documentation</a></li>
<li>Randy Olson's <a href="https://github.com/rhiever/Data-Analysis-and-Machine-Learning-Projects">data analysis and machine learning projects</a></li>
</ul>
<p>Additionally, Google, StackOverflow and the Angular.js documentation were incredibly helpful. <!-- 
* fruits
    + apples
        - macintosh
        - red delicious
    + pears
    + peaches
* fruits
    + apples
        - macintosh
        - red delicious
    + pears
    + peaches --> <!-- This could be a list of papers by the author for example  --> <!-- Also tutorials/people/stack overflow that was helpful.  --> <!-- tom's markdown -> latex  --> <!-- Below are selected screenshots of the calculator application and survey application in use. You encouraged to try them out yourself directly at [https://hepstack-stage.herokuapp.com/](https://hepstack-stage.herokuapp.com/). --></p>

<!-- 
Do not edit this page.

References are automatically generated from the BibTex file (References.bib)

...which you should create using your reference manager.
-->
<h1 id="references" class="unnumbered">References</h1>
<div id="refs" class="references">
<div id="ref-ferri2003volume">
<p>Ferri, C., Hernández-Orallo, J. &amp; Salido, M.A., 2003. Volume under the rOC surface for multi-class problems. In <em>Machine learning: ECML 2003</em>. Springer, pp. 108–120.</p>
</div>
<div id="ref-ghassemi2014data">
<p>Ghassemi, M.M. et al., 2014. A data-driven approach to optimized medication dosing: A focus on heparin. <em>Intensive care medicine</em>, 40(9), pp.1332–1339.</p>
</div>
<div id="ref-UWHEP">
<p>Lisa Gryttenholm, et a., Dan Hendrickson, 2004. Guidelines for the therapeutic dosing of heparin. Available at: <a href="http://www.uwhealth.org/files/uwhealth/docs/pdf2/Heparin_Infusion_Guideline.pdf" class="uri">http://www.uwhealth.org/files/uwhealth/docs/pdf2/Heparin_Infusion_Guideline.pdf</a>.</p>
</div>
<div id="ref-phd2014">
<p>Reka G Szigeti, P., MD, 2014. Anti-xa assay. Available at: <a href="http://emedicine.medscape.com/article/2085000-overview" class="uri">http://emedicine.medscape.com/article/2085000-overview</a>.</p>
</div>
<div id="ref-MIMICII">
<p>Saeed, M. et al., 2011. Multiparameter intelligent monitoring in intensive care iI (mimic-ii): A public-access intensive care unit database. <em>Critical Care Medicine</em>, 39, pp.952–960.</p>
</div>
<div id="ref-universityofwashingtonpharmacyservices2014">
<p>Washington Pharmacy Services, U. of, 2014. Heparin infusion guidelines. Available at: <a href="https://depts.washington.edu/anticoag/home/content/heparin-infusion-guidelines" class="uri">https://depts.washington.edu/anticoag/home/content/heparin-infusion-guidelines</a>.</p>
</div>
</div>
            </body>
</html>

